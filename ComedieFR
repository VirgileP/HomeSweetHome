#include <stdio.h>
#include <ctype.h>
#include <string.h>

#define NON_TROUVE -1
#define MAX_SPECTACLES 200

#define MAX_PL_Rich 862

#define MAX_TITRE 200
#define T_MAX_NOM 10
#define T_MAX_PRENOM 10


/*----------Declaration preliminaire-------------------------------*/
void charge_la_mule();
void charge_le_bulot();
void affichage_place();
void administration();
void Mot_de_passe();
void selection_theatre();
void affichage_programmation();
void conv_aff();
void conv_maj();
int recherche(char nomrech[T_MAX_TITRE], int tabres[]) ;

/*----------Declaration enregistrement-------------------------------*/

struct client
    {
      char 	titre[10]				;
      char	nom[T_MAX_NOM]      ;
      char	prenom[T_MAX_PRENOM];
      char  adresse[10]			;
      int	codePostal			;
      char	ville[10]				;
      char	pays[10]				;
      int	telephone			;
      int	numabo              ;
    };

struct spectacle
{
	char nom[T_MAX_TITRE]					;
	char auteur[100]				;
	char M_en_scene[200]			;
	char date_debut[200]			;
	char date_fin[200]				;
	char salle[400];
};

struct theatre
{
	char categorie				;
	char zone[50]				;
	int numpl					;
	char rangpl					;
};

/*----------variables globales--------------------*/
struct spectacle tab_program[200]	;
struct theatre place_richelieu[MAX_PL_Rich]; // +
int nbplace_dispo=0				;
int nbspecglob= 0; // nombre de pièces totales disponibles sur toute la comédie française
int	nbspectheatre = 0;
char frichelieu[20] = "RICHELIEU";
char fcolombier[20] = "COLOMBIER";
char fstudio[20] = "STUDIO";

/*-----------------------------------------*/
main()
{
	int choix = -1, nboccurrences = 0, i, numero	;
	char p_recherche[MAX_TITRE]			;
	struct spectacle representation			;
	int tabresultats[MAX_SPECTACLES]		;
	
	while (choix != 0)
	{
		printf("+-----------------+\n");
		printf("|Comédie Française|\n");
		printf("+-----------------+\n\n");
		charge_la_mule();
		charge_le_bulot();
		printf("-1- Programation\n");
		printf("-2- Réservation\n")	;
		printf("-3- Tarifs\n")		;
		printf("-4- Rechercher un spectacle\n")	; 
		printf("-5- Administration\n");	//login mdp			
		printf("-0- Quitter\n")		;
		printf("Choix : ")			;
		scanf("%d",&choix)			;
		
		switch(choix)
		{
			case 1: selection_theatre();
					break	;
			case 2: affichage_place()	;
					break		;
			case 3: printf("tarifs()")	;
					break	;
			case 4:if (nbspecglob == 0)
					{
					printf("Aucune pièce n'est actuellement disponible.\n");
					}
					else
					{
					printf("Entrez le premier mot de la pièce recherchée : ");
					scanf("%s", p_recherche);
					//test printf("%s", p_recherche);
					conv_maj(p_recherche)	;
					//printf("%s", p_recherche);
					conv_aff(p_recherche);
					//printf("%s", p_recherche);
					nboccurrences = recherche(p_recherche, tabresultats);
					if(nboccurrences == 0)
					{
					printf("\nAucun spectacle dont le nom commence par %s n'a été trouvé.\n",p_recherche);
					}
					else
					{
						
						for (i = 0;i < nboccurrences;i++)
						{
						numero = tabresultats[i];
						representation = tab_program[numero];
						printf("%s %s %s %s %s\n", representation.nom, representation.auteur, representation.M_en_scene, representation.date_debut, representation.date_fin);
						}
					}
					}
					break	;
			case 5: administration();
					break;
			case 0: printf("Au revoir\n")	;
					break				;
			default : printf("Erreur de saisie\n")	;
					break							;
		}
		
	}
}


/*--------------Selection théâtre------------------*/
void selection_theatre()
{
	int choix = -1;
	while(choix != 0)
	{
		printf("+------------+\n");
		printf("|Les Theatres|\n");
		printf("+------------+\n\n");
		
		printf("-1- Salle Richelieu\n");
		printf("-2- Theatre du Vieux-Colombier\n");
		printf("-3- Studio-Theatre\n");
		printf("-0- Retour au menu\n");
		printf("Selectionnez votre salle : ");
		scanf("%d", &choix);
		
		switch(choix)
		{
			case 1: affichage_programmation(frichelieu);
					break;
			case 2: affichage_programmation(fcolombier);
					break;
			case 3: affichage_programmation(fstudio);
					break;
			case 0: main();
					break;
			default : printf("Erreur de saisie\n");
					break;
			
		}
		
	}
}


/*-----------!charge uniquement - aucun affichage! la liste complète des spectales par théâtre------------------------------*/
void charge_la_mule()
{
	struct spectacle representation ;// recherche_programmation_théâtre()
	FILE *f1                        ;
	int i=0				;
 
	f1=fopen("theatre.txt","r"); //paramètre d'appelle de la variable fichier
	while(! feof(f1))
    {
    	fscanf(f1, "%s %s %s %s %s %s", representation.nom, representation.auteur, representation.M_en_scene, representation.date_debut, representation.date_fin, representation.salle);
    	tab_program[i]=representation; 
    		conv_aff(tab_program[i].nom)		;	  //déplacé ici pour traiter de données sous la même forme dans tout le pg
		conv_aff(tab_program[i].auteur)		;
		conv_aff(tab_program[i].M_en_scene)	;
		i=i+1;
	}
	fclose(f1);
	nbspecglob= i; // nombre de pièces totales disponibles sur toute la comédie française
	printf ("La mule a été chargée!...\n");
}
/*-------------affichage des spectacles en fonction du théâtre sélectionné-----------*/
void affichage_programmation(char nomtheatre[])
{
	int i, nbspectheatre=0; //nb de spectacle dipo par théatre en fonction de la demande (Richelieu, Vx-Colombier, Studio)
	printf("+-------------+\n");
 	printf("|Programmation|\n");
    	printf("+-------------+\n");
	for (i=0 ; i < nbspecglob; i++)
	{
		if (strcmp(nomtheatre,tab_program[i].salle) == 0)
		{
    	printf("nom de la piece : %s\n", tab_program[i].nom)			; //affichage_programmation()
    	printf("nom de l'auteur : %s\n", tab_program[i].auteur)	  		; 
    	printf("nom metteur en scene : %s\n", tab_program[i].M_en_scene);
    	printf("nom date de début : %s\n", tab_program[i].date_debut)	;
    	printf("nom date de fin : %s\n\n", tab_program[i].date_fin)  	;
    	nbspectheatre = nbspectheatre +1; 
    	}
	}
	printf("Pour selectionner le spectacle ecrivez le nom de la pièce : \n");
	//representation();
	// -0- retour
}
/*----------chargement des place de Richelieu---------------*/
void charge_le_bulot()
{
	struct theatre richelieu ;// recherche_programmation_théâtre()
	FILE *f1                        ;
	int i=0							;
 
	f1=fopen("prichelieu.txt","r"); //paramètre d'appelle de la variable fichier
	while(! feof(f1))
    {
    	fscanf(f1, "%s %s %d %c", richelieu.categorie, richelieu.zone, &richelieu.numpl, &richelieu.rangpl);
    	place_richelieu[i]=richelieu; //chargement des enregistrements dans le tableau de structure

		i=i+1;
	}
	//printf("i= %d", i);
	fclose(f1);
	nbplacetot= i; // nombre de pièces totales disponibles sur toute la comédie française
	printf ("Le bulot a été chargée!...\n");
}
/*------------affichage des places-----------*/
void affichage_place()
{
	int i;
	for(i=0; i<nbplacetot; i++)
	{
		conv_aff(place_richelieu[i].zone);
		conv_aff(place_richelieu[i].categorie);
		printf("categorie: %s\n", place_richelieu[i].categorie);
		printf("zone: %s\n", place_richelieu[i].zone);
		printf("place: %d\n", place_richelieu[i].numpl);
		if (place_richelieu[i].rangpl != '0'){
		printf("rang: %c\n", place_richelieu[i].rangpl); 
		}
	}		
}
/*--------------------Recherche d'une pièce par son titre----------------------*/
int recherche(char prefixe_p_rech[MAX_TITRE], int tabres[])
{
	struct spectacle representation	;
	int i, numrech = NON_TROUVE, nbocc = 0;
	int taille_prefixe ; 

	taille_prefixe = strlen(prefixe_p_rech)	;	
	for (i = 0; i < nbspecglob ; i++)
	{
	representation = tab_program[i]; 
	
		if (strncmp(representation.nom,prefixe_p_rech,taille_prefixe) == 0)
		{
		tabres[nbocc++] = i;
		}
	}
	return nbocc;
}

/*-----------------------------------------*/
void administration()
{
 Mot_de_passe();
}

/*--------------Sécurité---------------------*/
void Mot_de_passe()
{
	//bandeau d'accueil
	printf("+----------------------------------+\n")	;
	printf("|Comédie Française - Administration|\n")	;
	printf("+----------------------------------+\n\n")	;
	
	//déclaration des variables utilisées pour l'authentification
	char login_saisi[20]					;
	char login_verif[20]="ADMIN"				;
	char mdp_saisi[8]					;
	char mdp_verif [8]="BONJOUR"				;
	int reponse=0						;
	int test,test2,i					;

	//saisie du login et du mot de passe pour accéder à l'interface administrateur
	
	// Premier Essai pour la saisie du  login
	printf("Entrez votre login : ");
	scanf("%s",login_saisi);
	
	conv_maj(login_saisi);
	test = strcmp(login_saisi, login_verif);
		
		//Deuxième essai pour la saisie du login
		if (test != 0)
		{
		printf("Erreur d'authentification\n");
		printf("Recommencer la saisie du login : ");
		scanf("%s",login_saisi);
		conv_maj(login_saisi);

		test = strcmp(login_saisi, login_verif);
			
			//Au bout de deux erreurs sur le login, retour au menu principal
			if(test !=0)
			{
			printf("\nAccès Interdit.\n");
			printf("Vous allez être redirigé vers le menu d'accueil.\n\n");
			}
		}
	
	//Premier essai pour la saisie du mot de passe
	if( test == 0)
	{
	printf("Entrez votre mot de passe : ");
	scanf("%s", mdp_saisi);
	conv_maj(mdp_saisi);
			
	test2 = strcmp(mdp_saisi, mdp_verif);
	}
		//Deuxième essai pour la saisie du mot de passe
		if (test2 != 0)
		{
		printf("Erreur d'authentification.\n");
		printf("Recommencer la saisie du mot de passe : ");
		scanf("%s",mdp_saisi);
	
		conv_maj(mdp_saisi);
		
		test2 = strcmp(mdp_saisi, mdp_verif);
			
			//Au bout de deux erreurs sur le login, retour au menu principal
			if(test2 !=0)
			{
			printf("\nAccès Interdit.\n");
			printf("Vous allez être redirigé vers le menu d'accueil.\n\n");
			}
		}	
				
		
	//L'authentification réussie donne accès à la partie administration du logiciel
	if ((test == 0)&&(test2 == 0))
		{
		printf("\nWelcome + voids dédiés\n");
		}
}

/*------convertisseurs_entree_fichier-----------------------------------*/
void conv_maj(char tab[])
{
  int i, taille ;
  
  taille = strlen(tab);
  for (i=0 ; i< taille ; i++)
  {
  	if(tab[i] == ' ')
  	{
  		tab[i] = '_';
	}
	else
	{
		tab[i] = toupper(tab[i]);
	}
    
  }
}

/*------convertisseur_affichage_fichier--------------------*/
void conv_aff(char tab[])
{
	int i, taille;
	
	taille = strlen(tab);
	for (i=1; i<taille; i++)
	{
		if(tab[i] == '_')
		{
			tab[i] = ' ';
			i++;
		}
		else
		{
		tab[i] = tolower(tab[i]);
		}
		
	}
}
